# LeanCloud云函数部署说明

## ✅ 问题已修复

### 问题描述
部署时遇到npm依赖安装失败：
```
npm error notarget No matching version found for leanengine@^4.0.0.
```

### 解决方案
已将依赖版本更新为稳定版本：

**修改前：**
```json
"dependencies": {
  "leanengine": "^4.0.0",        // ❌ 此版本不存在
  "leancloud-storage": "^4.13.0"
}
```

**修改后：**
```json
"dependencies": {
  "leanengine": "^3.4.0",        // ✅ 稳定版本
  "leancloud-storage": "^3.15.0" // ✅ 稳定版本
}
```

---

## 🚀 部署步骤

### 方式一：从GitHub部署（推荐）

1. **登录LeanCloud控制台**
   - 访问：https://console.leancloud.cn/

2. **进入云引擎设置**
   - 选择您的应用
   - 点击【云引擎】→【设置】

3. **配置Git部署**
   - 选择【Git部署】
   - 仓库地址：`https://github.com/Zee1988/LCCF.git`
   - 分支：`master`
   - 点击【保存】

4. **配置环境变量**
   
   在【云引擎】→【设置】→【环境变量】中添加：
   
   | 变量名 | 值 | 说明 |
   |--------|-----|------|
   | YUNGOU_MCH_ID | 你的商户号 | 云勾支付商户号 |
   | YUNGOU_API_KEY | 你的API密钥 | 云勾支付API密钥 |
   | PAYMENT_NOTIFY_URL | https://你的应用.leanapp.cn/api/payment/callback | 支付回调地址 |

5. **部署**
   - 点击【部署】按钮
   - 选择【生产环境】
   - 等待部署完成（约1-3分钟）

---

### 方式二：使用命令行部署

1. **安装LeanCloud CLI**
   ```bash
   npm install -g leancloud-cli
   ```

2. **登录**
   ```bash
   lean login
   ```

3. **克隆仓库**
   ```bash
   git clone https://github.com/Zee1988/LCCF.git
   cd LCCF
   ```

4. **关联应用**
   ```bash
   lean switch
   ```
   选择您的应用

5. **部署**
   ```bash
   # 部署到生产环境
   lean deploy --prod
   
   # 或部署到预备环境测试
   lean deploy
   ```

---

## 📋 部署后检查清单

### 1. 检查云函数是否部署成功

在【云引擎】→【云函数】中应该能看到：
- ✅ `createOrder` - 创建订单
- ✅ `queryOrder` - 查询订单

### 2. 检查环境变量

在【云引擎】→【设置】→【环境变量】中确认：
- ✅ YUNGOU_MCH_ID 已配置
- ✅ YUNGOU_API_KEY 已配置
- ✅ PAYMENT_NOTIFY_URL 已配置

### 3. 创建数据表

在【数据存储】→【结构化数据】中创建：

**Order表：**
| 字段名 | 类型 | 说明 |
|--------|------|------|
| orderId | String | 云勾订单号 |
| userId | Pointer(_User) | 关联用户 |
| productType | String | 产品类型 |
| amount | Number | 金额（分） |
| status | String | 订单状态 |
| payMethod | String | 支付方式 |
| outTradeNo | String | 商户订单号 |
| transactionId | String | 微信交易号 |
| paidAt | Date | 支付时间 |

**扩展_User表：**
| 字段名 | 类型 | 说明 |
|--------|------|------|
| vipType | String | VIP类型 |
| vipExpireTime | Date | VIP过期时间 |
| vipPurchaseTime | Date | VIP购买时间 |
| vipOrderIds | Array | 订单ID列表 |

### 4. 测试云函数

在【云引擎】→【云函数】中测试：

**测试createOrder：**
```javascript
{
  "productType": "lifetime"
}
```

预期返回：
```javascript
{
  "orderId": "...",
  "outTradeNo": "...",
  "appId": "...",
  "prepayId": "...",
  ...
}
```

---

## 🔧 故障排查

### 问题1：部署失败 - npm install错误

**解决方案：**
- ✅ 确认使用的是修复后的`package.json`
- ✅ 检查Node.js版本（需要>=14.0.0）
- ✅ 查看部署日志获取详细错误信息

### 问题2：云函数无法调用

**检查：**
- [ ] 云函数是否部署成功
- [ ] 环境变量是否配置正确
- [ ] 查看云引擎日志

### 问题3：支付回调失败

**检查：**
- [ ] 回调地址是否正确配置
- [ ] 回调接口是否可访问（测试：`curl https://你的应用.leanapp.cn/api/payment/callback`）
- [ ] API密钥是否正确

---

## 📞 获取帮助

- **LeanCloud文档：** https://leancloud.cn/docs/
- **云勾支付文档：** https://open.pay.yungouos.com/
- **GitHub仓库：** https://github.com/Zee1988/LCCF

---

## 📝 更新日志

| 日期 | 版本 | 说明 |
|------|------|------|
| 2026-01-03 | 1.0.1 | 修复依赖版本问题 |
| 2026-01-03 | 1.0.0 | 初始版本 |

---

**现在可以成功部署了！** 🎉

